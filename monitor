#!/bin/sh

# TODO logging

inotifywait -m ~/sites-updates -e modify -e create -e moved_to |
    while read dir action file; do
        echo "The file '$file' appeared in directory '$dir' via '$action'"

        if [[ "$file" == *.tar.xz* ]]; then

            folder=null

            case "$file" in
            "martials.no")
                folder=home
                ;;
            "api")
                folder=api
                ;;
            "nextcloud")
                folder=nextcloud
                ;;
            esac

            folder=test                    # TODO Remove
            if [ "$folder" != null ]; then # TODO transaction, all or nothing, use backup
                rootFolder=/var/www/"$folder"

                sudo cp "$rootFolder" "$rootFolder".bak # Backups folder

                if [ -e "$rootFolder".bak ]; then

                    echo yes | sudo rm $rootFolder/* # Removes contents in folder

                    sudo mv "$dir"/"$file" "$rootFolder" # Moves tar to correct folder
                    sudo tar -xf "$rootFolder"/"$file"   # Extracts tar

                    echo yes | sudo rm "$rootFolder"/"$file" # Deletes tar
                fi

            else
                echo 'Folder not specified, could be wrong archive name' >&2
            fi

        fi

    done
