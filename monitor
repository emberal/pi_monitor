#!/bin/bash

# TODO logging

inotifywait -m ~/sites-updates -e modify -e create -e moved_to |
    while read dir action file; do
        echo "The file '$file' appeared in directory '$dir' via '$action'"

        if [[ "$file" == *.tar.xz* ]]; then

            folder=null

            case "$file" in
            "martials_no")
                folder=home
                ;;
            "api_martials_no")
                folder=api
                ;;
            "nextcloud")
                folder=nextcloud
                ;;
            esac

	    folder=test # TODO Remove
            if [ "$folder" != null ]; then # TODO transaction, all or nothing
                echo y | sudo rm /var/www/"$folder"/*

                sudo mv "$dir"/"$file" /var/www/"$folder"
                sudo tar -xf /var/www/"${folder}/$file"

                echo yes | sudo rm /var/www/"${folder}/$file"
            fi

        fi

    done
